<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <!-- 密码验证保护 -->
  <script>
    (function() {
      // 如果当前在验证页面，不执行检查
      if (window.location.pathname === '/auth.html') {
        console.log('[Auth] 当前在验证页面，跳过检查');
        return;
      }
      
      console.log('[Auth] 开始验证...');
      
      // 获取token
      var _0xauth = localStorage.getItem('_auth_tk') || 
                   sessionStorage.getItem('_auth_tk');
      
      // 如果前两个都没有，再从cookie获取
      if (!_0xauth) {
        var cookieMatch = document.cookie.split('; ').find(function(row) { 
          return row.startsWith('_auth_tk='); 
        });
        if (cookieMatch) {
          _0xauth = cookieMatch.split('=')[1];
        }
      }
      
      console.log('[Auth] Token:', _0xauth ? '已找到' : '未找到');
      
      if (!_0xauth) {
        console.log('[Auth] Token不存在，跳转到验证页面');
        window.location.href = '/auth.html';
        return;
      }
      
      try {
        var decoded = atob(_0xauth);

        if (decoded.indexOf('::verified::') === -1) {
          console.log('[Auth] Token无效（未包含verified标记），跳转到验证页面');
          window.location.href = '/auth.html';
          return;
        }

        var parts = decoded.split('::');
        if (parts.length < 3 || parts[1] !== 'verified') {
          console.log('[Auth] Token结构异常，跳转到验证页面');
          window.location.href = '/auth.html';
          return;
        }
        var timestamp = parseInt(parts[0]);
        var now = new Date().getTime();
        var age = now - timestamp;

        if (isNaN(timestamp)) {
          console.log('[Auth] Token时间戳无效，跳转到验证页面');
          window.location.href = '/auth.html';
          return;
        }
        
        console.log('[Auth] Token时间戳:', timestamp);
        console.log('[Auth] 当前时间:', now);
        console.log('[Auth] Token年龄(小时):', (age / 3600000).toFixed(2));
        
        if (age >= 86400000) {
          console.log('[Auth] Token已过期，清除并跳转到验证页面');
          localStorage.removeItem('_auth_tk');
          sessionStorage.removeItem('_auth_tk');
          document.cookie = '_auth_tk=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          window.location.href = '/auth.html';
        } else {
          console.log('[Auth] 验证通过，允许访问');
        }
      } catch(e) {
        console.log('[Auth] Token解析失败:', e.message);
        window.location.href = '/auth.html';
      }
    })();
  </script>
  
  <%
  var title = page.title;

  if (is_archive()){
    title = 'Archives';

    if (is_month()){
      title += ': ' + page.year + '/' + page.month;
    } else if (is_year()){
      title += ': ' + page.year;
    }
  } else if (is_category()){
    title = 'Category: ' + page.category;
  } else if (is_tag()){
    title = 'Tag: ' + page.tag;
  }
  %>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="<%= config.url %>">
  <title><% if (title){ %><%= title %> | <% } %><%= config.title %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <%- open_graph({twitter_id: theme.twitter, google_plus: theme.google_plus, fb_admins: theme.fb_admins, fb_app_id: theme.fb_app_id}) %>
  <% if (theme.rss){ %>
    <link rel="alternative" href="<%- theme.rss %>" title="<%= config.title %>" type="application/atom+xml">
  <% } %>
  <% if (theme.favicon){ %>
    <link rel="icon" href="<%- theme.favicon %>">
  <% } %>
  <%- partial('css') %>
  <style type="text/css">
  <% var defaultCtnBg = 'linear-gradient(200deg,#a0cfe4,#e8c37e)' %>
    #container.show {
      background: <%= theme.style && theme.style.slider ? theme.style.slider : defaultCtnBg %>;
    }
  </style>
  <%- partial('google-analytics') %>
  <%- partial('baidu-analytics') %>
</head>
